<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Eternal Dawn</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500&display=swap" rel="stylesheet">
  <style>
    body { 
      font-family: 'Cinzel', serif; 
      margin: 0; 
      overflow: hidden;
      background: #000; 
    }

    /* Game container */
    #game {
      width: 100vw;
      height: 100vh;
      position: relative;
      overflow: hidden;
    }

    /* Background image */
    #bgImage {
      width: 100%;
      height: 100%;
      object-fit: cover;
      filter: blur(10px) brightness(0.6);
      transition: filter 1.2s ease, opacity 0.8s ease;
      opacity: 1;
    }
    #bgImage.focused { filter: blur(0) brightness(1); }

    /* Fade helpers for transitions */
    .fade-out { opacity: 0 !important; transition: opacity 0.8s ease; }
    .fade-in  { opacity: 1 !important; transition: opacity 0.8s ease; }

    /* Wake-up eyelids (top & bottom) - will translate away */
    #wakeUpTop, #wakeUpBottom {
      position: absolute;
      left: 0;
      width: 100%;
      height: 50%;
      background: rgba(0,0,0,0.92); /* mostly opaque but slightly transparent */
      z-index: 60;
      transition: transform 1s ease;
      pointer-events: none;
    }
    #wakeUpTop { top: 0; transform: translateY(0); }
    #wakeUpBottom { bottom: 0; transform: translateY(0); }
    #wakeUpTop.open { transform: translateY(-100%); }
    #wakeUpBottom.open { transform: translateY(100%); }

    /* Main character */
    #mainCharacter {
      position: absolute;
      bottom: 2%;
      left: 50%;
      transform: translateX(-50%);
      max-height: 78%;
      opacity: 0;
      transition: opacity 0.9s ease, left 1.1s ease;
      pointer-events: none;
      z-index: 30;
    }
    #mainCharacter.visible { opacity: 1; }
    #mainCharacter.drift-left { left: 18%; }

    /* Dialogue box (inside canvas) */
    .parchment-bubble {
      background: url('assets/img/aged-paper.png');
      background-size: cover;
      border: 3px solid #a1866f;
      border-radius: 1.2rem;
      box-shadow: 0 6px 18px rgba(0,0,0,0.5);
      width: 70%;
      max-width: 980px;
      text-align: center;
      padding: 1.0rem 1.25rem;
      position: absolute;
      bottom: 4%;
      left: 50%;
      transform: translateX(-50%);
      z-index: 40;
    }

    #dialogueText {
      font-size: 1.25rem;
      line-height: 1.7rem;
      color: #fff;
      text-shadow: 1px 1px 6px rgba(0,0,0,0.85);
      min-height: 3.4rem;
    }

    /* Choices (default + hover dark beige) */
    .choice-btn {
      background: rgba(255, 255, 255, 0.92);
      color: #2a1e1e;
      font-weight: 700;
      border: 2px solid #a1866f;
      border-radius: 0.75rem;
      padding: 0.5rem 1.1rem;
      opacity: 0;
      transform: translateY(18px);
      transition: all 0.35s ease;
      width: fit-content;
      margin: 0.5rem auto;
      display: block;
      cursor: pointer;
    }
    .choice-btn.show { opacity: 1; transform: translateY(0); }
    .choice-btn:hover {
      background: #b99772;   /* dark beige */
      color: #fff;
      transform: translateY(-3px) scale(1.03);
      box-shadow: 0 6px 18px rgba(0,0,0,0.28);
    }

    /* Responsive tweaks */
    @media (max-width: 768px) {
      .parchment-bubble { width: 92%; padding: 0.9rem; bottom: 3.5%; }
      #dialogueText { font-size: 1.05rem; }
      #mainCharacter { max-height: 56%; bottom: 1%; }
    }
  </style>
</head>
<body>

  <!-- Start Screen -->
  <div id="startScreen" class="flex flex-col items-center justify-center text-center h-screen bg-[#fdf6e3]">
    <h1 class="text-4xl font-bold mb-6 text-yellow-700">ðŸŒŸ Eternal Dawn ðŸŒŸ</h1>
    <p class="mb-4 text-lg text-gray-700">A mythological story adventure. Choose your path wisely...</p>
    <button id="startBtn" class="bg-yellow-600 text-white px-6 py-3 rounded-lg hover:bg-yellow-700 transition">
      Begin Adventure
    </button>
  </div>

  <!-- Game Container -->
  <div id="game" class="hidden">
    <img id="bgImage" src="assets/img/Ruined_Temple.png" alt="Background"/>
    <img id="mainCharacter" src="assets/img/main_character.png" alt="Hero"/>
    <div id="dialogueBox" class="parchment-bubble hidden">
      <p id="dialogueText" class="italic"></p>
      <div id="choices" class="flex flex-col items-center"></div>
    </div>

    <!-- Eyelids (top/bottom) - removed after opening completes -->
    <div id="wakeUpTop"></div>
    <div id="wakeUpBottom"></div>
  </div>

  <script>
    // --- AUDIO ---
    let ambient, godsVoice;
    function initAudio() {
      ambient = new Howl({
        src: ["assets/audio/mystical-temple-audio.mp3"],
        loop: true,
        volume: 0.5,
        onloaderror: (id, err) => console.warn("Ambient load error", err)
      });
      godsVoice = new Howl({
        src: ["assets/audio/gods-voice.mp3"],
        volume: 1.0,
        onloaderror: (id, err) => console.warn("Gods voice load error", err)
      });
    }

    // --- STORY DATA (Act 1 branches implemented) ---
    const story = {
      act1: {
        scene1: {
          text: "You awaken in the ruins of an ancient temple, your powers flickering. A divine voice echoes...",
          background: "assets/img/Ruined_Temple.png",
          narration: "The time has come, child of heaven... choose your path, for destiny awaits.",
          choices: [
            { text: "Follow the celestial call", next: "godsPath" },
            { text: "Seek the humans in the village", next: "humansPath" },
            { text: "Walk into the shadows", next: "demonsPath" }
          ]
        },
        godsPath: {
          text: "Golden light bathes you as you ascend the celestial steps...",
          background: "assets/img/Celestial_Gate.png",
          narration: "Before you stand the guardians of the divine realm. Their eyes test your soul.",
          choices: [
            { text: "Step through the gate", next: "godsGate" },
            { text: "Challenge the guardians", next: "godsFight" },
            { text: "Return to earth", next: "scene1" }
          ]
        },
        humansPath: {
          text: "You walk into a humble village where whispers follow your every step...",
          background: "assets/img/Village_Square.png",
          narration: "The elder approaches, wary yet respectful. 'Are you the one foretold in the old songs?'",
          choices: [
            { text: "Speak to the elder", next: "humansElder" },
            { text: "Help the villagers", next: "humansHelp" },
            { text: "Leave silently", next: "scene1" }
          ]
        },
        demonsPath: {
          text: "The forest grows darker with every step, shadows dancing unnaturally...",
          background: "assets/img/Shadow_Forest.png",
          narration: "From the mist, monstrous forms emerge. The demons hunger for your soul.",
          choices: [
            { text: "Fight the demons", next: "demonsFight" },
            { text: "Hide in the shadows", next: "demonsHide" },
            { text: "Seek the dark altar", next: "demonsAltar" }
          ]
        },
        // placeholder deeper nodes so loadScene won't break
        godsGate: { text: "You enter the gate...", background: "assets/img/Celestial_Gate.png", narration: "A new test begins.", choices: [{text:"Continue", next:"scene1"}] },
        godsFight:{ text:"You dare fight...", background:"assets/img/Celestial_Gate.png", narration:"Battle begins.", choices:[{text:"Continue", next:"scene1"}] },
        humansElder:{ text:"The elder speaks...", background:"assets/img/Village_Square.png", narration:"Wisdom shared.", choices:[{text:"Continue", next:"scene1"}] },
        humansHelp:{ text:"You help the villagers...", background:"assets/img/Village_Square.png", narration:"Gratitude follows.", choices:[{text:"Continue", next:"scene1"}] },
        demonsFight:{ text:"You clash with shadows...", background:"assets/img/Shadow_Forest.png", narration:"Blood and storm.", choices:[{text:"Continue", next:"scene1"}] },
        demonsHide:{ text:"You hide and listen...", background:"assets/img/Shadow_Forest.png", narration:"Silence and scent.", choices:[{text:"Continue", next:"scene1"}] },
        demonsAltar:{ text:"The altar hums...", background:"assets/img/Shadow_Forest.png", narration:"Dark rites awaken.", choices:[{text:"Continue", next:"scene1"}] }
      }
    };

    // DOM refs
    const startScreen = document.getElementById('startScreen');
    const startBtn = document.getElementById('startBtn');
    const game = document.getElementById('game');
    const bgImage = document.getElementById('bgImage');
    const mainCharacter = document.getElementById('mainCharacter');
    const wakeUpTop = document.getElementById('wakeUpTop');
    const wakeUpBottom = document.getElementById('wakeUpBottom');
    const dialogueBox = document.getElementById('dialogueBox');
    const dialogueText = document.getElementById('dialogueText');
    const choicesBox = document.getElementById('choices');

    let currentScene = story.act1.scene1;

    // simple typewriter (no sync)
    function typeWriter(text, el, speed = 35, cb) {
      el.textContent = "";
      let i = 0;
      function tick() {
        if (i < text.length) {
          el.textContent += text.charAt(i++);
          setTimeout(tick, speed);
        } else if (cb) cb();
      }
      tick();
    }

    // typewriter synced with Howler audio duration (safe fallback if audio not loaded)
    function typeWriterSync(text, el, audioHowl, cb) {
      el.textContent = "";
      let i = 0;

      function startWithDuration(durSec) {
        const durationMs = Math.max(durSec * 1000, 700); // min duration
        const speed = durationMs / Math.max(text.length, 1);
        audioHowl.play();
        function tick() {
          if (i < text.length) {
            el.textContent += text.charAt(i++);
            setTimeout(tick, speed);
          } else if (cb) cb();
        }
        tick();
      }

      // If audio duration available, use it; else wait for load or fallback
      const dur = (audioHowl && typeof audioHowl.duration === 'function') ? audioHowl.duration() : 0;
      if (dur && dur > 0) {
        startWithDuration(dur);
      } else {
        // wait briefly for load event
        if (audioHowl && typeof audioHowl.once === 'function') {
          audioHowl.once('load', () => startWithDuration(audioHowl.duration()));
        }
        // fallback if load doesn't happen
        setTimeout(() => {
          if (i === 0) typeWriter(text, el, 45, cb);
        }, 2000);
      }
    }

    // Opening sequence (handles eyelids, blur clear, hero fade-in + drift, then dialogue)
    function playOpeningSequence(scene) {
      // ensure eyelids visible
      wakeUpTop.style.display = 'block';
      wakeUpBottom.style.display = 'block';
      wakeUpTop.classList.remove('open');
      wakeUpBottom.classList.remove('open');

      // small delay then open eyelids
      setTimeout(() => {
        wakeUpTop.classList.add('open');
        wakeUpBottom.classList.add('open');
      }, 300);

      // when eyelids have opened (after transition), remove them and clear blur
      setTimeout(() => {
        // clear blur to focus background
        bgImage.classList.add('focused');
        // remove eyelids from DOM/flow so they won't block clicks or show vignette
        wakeUpTop.style.display = 'none';
        wakeUpBottom.style.display = 'none';
      }, 1400); // matches the CSS transition timing (1s) + small buffer

      // hero fades in shortly after eyelids start opening
      setTimeout(() => mainCharacter.classList.add('visible'), 1400);

      // pause center, then drift left
      setTimeout(() => {
        mainCharacter.classList.add('drift-left');
      }, 2900); // ~1.5s pause in center

      // after drift completes, show dialogue (timings tuned)
      setTimeout(() => {
        showDialogueForScene(scene);
      }, 4200); // allow drift (approx 1.1s) to finish
    }

    // show dialogue (intro text then narration + choices)
    function showDialogueForScene(scene) {
      dialogueBox.classList.remove('hidden');
      dialogueText.textContent = "";
      choicesBox.innerHTML = "";

      // first quick intro text (scene.text)
      typeWriter(scene.text, dialogueText, 36, () => {
        // small pause then play synced narration
        setTimeout(() => {
          typeWriterSync(scene.narration, dialogueText, godsVoice, () => {
            // show choices
            scene.choices.forEach((choice, idx) => {
              const btn = document.createElement('button');
              btn.className = 'choice-btn';
              btn.textContent = choice.text;
              btn.onclick = () => transitionToScene(choice.next);
              choicesBox.appendChild(btn);
              setTimeout(() => btn.classList.add('show'), idx * 260);
            });
          });
        }, 500);
      });
    }

    // Transition to next scene (fade out/in)
    function transitionToScene(nextKey) {
      const scene = story.act1[nextKey];
      if (!scene) {
        console.warn("No scene for key:", nextKey);
        return;
      }

      // fade out current UI
      dialogueBox.classList.add('fade-out');
      mainCharacter.classList.add('fade-out');
      bgImage.classList.add('fade-out');

      // small delay to let fade finish, then swap background and reset UI
      setTimeout(() => {
        // reset dialogue and choices
        dialogueText.textContent = "";
        choicesBox.innerHTML = "";
        dialogueBox.classList.add('hidden', 'fade-out');

        // swap background
        bgImage.src = scene.background;
        // ensure bg visible after load
        bgImage.onload = () => {
          bgImage.classList.remove('fade-out');
          bgImage.classList.add('fade-in');
          // ensure focused (no blur) once background shown
          setTimeout(() => bgImage.classList.add('focused'), 250);
        };

        // bring character back (keeps left position)
        mainCharacter.classList.remove('fade-out');
        mainCharacter.classList.add('visible', 'drift-left');

        // small delay then display dialogue + narration
        setTimeout(() => {
          showDialogueForScene(scene);
        }, 900);
      }, 700);
    }

    // initial entrypoint when start clicked
    startBtn.addEventListener('click', () => {
      startScreen.classList.add('hidden');
      game.classList.remove('hidden');

      initAudio();
      // safe to play ambient now (user gesture)
      ambient.play();

      // play opening sequence for scene1
      playOpeningSequence(currentScene);
    }, { once: true });
  </script>
</body>
</html>
